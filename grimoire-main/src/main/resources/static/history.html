<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>История заклинаний</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Alfa+Slab+One&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav>
  <a href="/dashboard.html"><i class="fas fa-book"></i> Кабинет</a>
  <a href="/spells.html"><i class="fas fa-magic"></i> Заклинания</a>
  <a href="/artifacts.html"><i class="fas fa-crown"></i> Артефакты</a>
  <a href="/history.html"><i class="fas fa-scroll"></i> История</a>
  <a href="#" onclick="logout(); return false;"><i class="fas fa-door-open"></i> Выйти</a>
</nav>

<div class="magic-header">
  <h2><i class="fas fa-scroll"></i> История заклинаний</h2>
  <div class="magic-moon"><i class="fas fa-moon"></i></div>
</div>

<div id="historyContainer">
  <p>Загрузка истории...</p>
</div>

<script src="/js/api.js"></script>
<script>
  async function loadHistory() {
      try {
          checkAuth();
          const casts = await api.getActiveSpells();
          const container = document.getElementById('historyContainer');

          if (casts.length === 0) {
              container.innerHTML = `
                  <div class="no-records">
                      <i class="fas fa-book-open"></i>
                      <p>В древних свитках нет записей о ваших заклинаниях.</p>
                  </div>
              `;
              return;
          }

          const rows = casts.map(c => {
              const time = new Date(c.castTime).toLocaleString('ru-RU', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
              });
              return `
                  <tr>
                      <td>${c.spellName || '—'}</td>
                      <td>${c.victimName || '—'}</td>
                      <td>${time}</td>
                      <td>${getStatusHtml(c.status)}</td>
                  </tr>
              `;
          }).join('');

          container.innerHTML = `
              <table>
                  <thead>
                      <tr>
                          <th><i class="fas fa-spell-check"></i> Заклинание</th>
                          <th><i class="fas fa-user"></i> Жертва</th>
                          <th><i class="fas fa-clock"></i> Время</th>
                          <th><i class="fas fa-info-circle"></i> Статус</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${rows}
                  </tbody>
              </table>
          `;
      } catch (err) {
          container.innerHTML = `<p class="message error">Ошибка: ${err.message}</p>`;
      }
  }

  function getStatusHtml(status) {
      if (status === 'active') return `<span class="status-active"><i class="fas fa-circle" style="font-size:0.8em;"></i> Активно</span>`;
      if (status === 'removed') return `<span class="status-removed"><i class="fas fa-ban" style="font-size:0.8em;"></i> Снято</span>`;
      return `<span style="color: #8d7a65;"><i class="fas fa-question-circle"></i> ${status}</span>`;
  }

  function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('wizardId');
      localStorage.removeItem('wizardLogin');
      window.location.href = '/login.html';
  }

  loadHistory();
</script>
</body>
</html>